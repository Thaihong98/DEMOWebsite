<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LiveChat OAuth Demo</title>
</head>
<body>
  <h2>LiveChat OAuth 2.1 Example</h2>
  <button id="loginBtn">Login with LiveChat</button>
  <pre id="output"></pre>

  <script>
    const clientId = "YOUR_CLIENT_ID"; // from LiveChat Developer Console
    const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
    const scope = encodeURIComponent("customers:rw");

    const authUrl =
      `https://accounts.livechat.com/authorize?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;

    // --- Step 1: Redirect user to LiveChat login ---
    document.getElementById("loginBtn").onclick = () => {
      window.location.href = authUrl;
    };

    // --- Step 2: Extract token after redirect ---
    function getAccessTokenFromUrl() {
      const hash = window.location.hash.substring(1); // remove #
      const params = new URLSearchParams(hash);
      return params.get("access_token");
    }

    const accessToken = getAccessTokenFromUrl();

    if (accessToken) {
      document.getElementById("output").textContent = "Access Token: " + accessToken;

      // --- Step 3: Call LiveChat API with token ---
      async function updateCustomerInfo() {
        const customerId = "CURRENT_CUSTOMER_ID"; // you need the real one from your app context
        const updateData = {
          id: customerId,
          name: "New Name",
          email: "new.email@example.com",
          avatar: "https://example.com/new-avatar.png",
          session_fields: [
            { key: "custom_key", value: "custom_value" }
          ],
        };

        const response = await fetch("https://api.livechatinc.com/v3.6/agent/action/update_customer", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json",
            "X-API-Version": "3.6",
          },
          body: JSON.stringify(updateData),
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById("output").textContent = "Customer updated:\n" + JSON.stringify(data, null, 2);
        } else {
          const error = await response.json();
          document.getElementById("output").textContent = "Error:\n" + JSON.stringify(error, null, 2);
        }
      }

      // Auto-call update function once token is present
      updateCustomerInfo();
    }
  </script>
</body>
</html>
