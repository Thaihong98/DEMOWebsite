<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tawk.to Chat Example</title>
</head>

<body>
  <h1>Welcome</h1>
  <p>Chat with us using the widget in the corner.</p>

  <!--Start of Tawk.to Script-->
  <script type="text/javascript">
    (function () {
      'use strict';
      const OriginalWebSocket = window.WebSocket;
      let lastTawkWs = null;

      window.WebSocket = function (url, protocols) {
        if (!url || !url.includes('tawk')) return new OriginalWebSocket(url, protocols);
        const ws = protocols ? new OriginalWebSocket(url, protocols) : new OriginalWebSocket(url);
        lastTawkWs = ws;
        const originalSend = ws.send.bind(ws);
        let initSetAttributes = false;

        ws.send = function (data) {
          try {
            // if (!initSetAttributes) {
            //   initSetAttributes = true;
            //   // '4{"c":"setAttributes","cb":1,"p":[{"name":"John Doe","email":"john@example.com","id":"USER-123"}]}'
            //   const customPacket = {
            //     c: 'setAttributes',
            //     cb: 1,
            //     p: [
            //       {
            //         name: 'John Doe',
            //         email: 'john@example.com',
            //         id: 'USER-123'
            //       }
            //     ]
            //   };

            //   const raw = '4' + JSON.stringify(customPacket);
            //   console.log('Injecting custom packet before first send:', raw);
            //   window.tawkSend(raw);
            // }

            if (typeof data === 'string' && data.startsWith('4{')) {
              const parsed = JSON.parse(data.slice(1));
              if (parsed.c === 'service' && parsed.p?.[1] === '/v1/message/visitor') {
                console.log('Intercepted visitor message:', parsed.p[2].message);
              }
            }
          } catch (e) {
            console.error('Interceptor websocket send error' + e);
          }
          return originalSend(data);
        };
        return ws;
      };

      window.WebSocket.prototype = OriginalWebSocket.prototype;
      ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'].forEach(k => window.WebSocket[k] = OriginalWebSocket[k]);

      // helper to reuse captured websocket
      window.tawkSend = function (raw) {
        if (!lastTawkWs) return console.warn('No Tawk WebSocket captured yet');
        if (lastTawkWs.readyState !== OriginalWebSocket.OPEN)
          return console.warn('Tawk socket not open yet');
        lastTawkWs.send(raw);
      };

      console.log('Interceptor ready');
    })();

    var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
    (function () {
      var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = 'https://embed.tawk.to/68f9a0afd84f3b1958007fd2/1j87hnbo1';
      s1.charset = 'UTF-8';
      s1.setAttribute('crossorigin', '*');
      s0.parentNode.insertBefore(s1, s0);
    })();
    window.Tawk_API.onLoad = function () {
      window.Tawk_API.setAttributes(
        {
          name: 'John Doe99' + Date.now(),
          email: 'visitor@yourdomain.com',
          id: 'USER-123',         // optional custom ID for your tracking
          // hash: 'SECURE_HASH'     // optional, for secure mode
        },
        function (error) {
          if (error) console.error('Tawk setAttributes error:', error);
          else console.log('Attributes set');
        }
      );
    };

  </script>
  <!--End of Tawk.to Script-->
</body>

</html>