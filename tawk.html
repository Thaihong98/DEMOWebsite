<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tawk.to Chat Example</title>
</head>

<body>
  <h1>Welcome</h1>
  <p>Chat with us using the widget in the corner.</p>

  <!--Start of Tawk.to Script-->
  <script type="text/javascript">
    (function () {
      'use strict';

      const OriginalWebSocket = window.WebSocket;
      let lastTawkWs = null;
      let lastTemplate = null;
      let sendQueue = [];

      function flushQueue() {
        if (!lastTawkWs || lastTawkWs.readyState !== OriginalWebSocket.OPEN) return;
        while (sendQueue.length) lastTawkWs.send(sendQueue.shift());
      }

      window.WebSocket = function (url, protocols) {
        const ws = protocols ? new OriginalWebSocket(url, protocols) : new OriginalWebSocket(url);
        if (url && url.includes('tawk')) {
          lastTawkWs = ws;

          ws.addEventListener('open', () => flushQueue());
          ws.addEventListener('close', () => { /* keep lastTawkWs for diagnostics */ });
        }

        const originalSend = ws.send.bind(ws);

        ws.send = function (data) {
          try {
            if (typeof data === 'string' && data.startsWith('4{')) {
              const parsed = JSON.parse(data.substring(1));
              // keep a template of the intercepted packet so we can reuse structure
              lastTemplate = parsed;
              // example modification (optional)
              if (parsed.c === 'service' && parsed.p && parsed.p[1] === '/v1/message/visitor') {
                const msg = parsed.p[2];
                console.log('Intercepted visitor message:', msg.message);
                // msg.message = '[MODIFIED] ' + msg.message; // uncomment to auto-modify
                parsed.p[2] = msg;
                data = '4' + JSON.stringify(parsed);
              }
            }
          } catch (e) { /* ignore parse errors */ }

          return originalSend(data);
        };

        return ws;
      };

      // preserve constants and prototype
      window.WebSocket.prototype = OriginalWebSocket.prototype;
      ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'].forEach(k => {
        window.WebSocket[k] = OriginalWebSocket[k];
      });

      // Public helper: send raw string via intercepted websocket (queues if not open)
      window.tawkSendRaw = function (raw) {
        if (!lastTawkWs) throw new Error('No tawk websocket captured yet');
        if (lastTawkWs.readyState === OriginalWebSocket.OPEN) {
          lastTawkWs.send(raw);
        } else {
          sendQueue.push(raw);
        }
      };

      // Public helper: send a visitor message using the intercepted packet template.
      // text: string message to send
      window.tawkSendVisitorMessage = function (text) {
        if (!lastTemplate) {
          // fallback minimal packet if no template captured yet
          const fallback = { c: 'service', p: [null, '/v1/message/visitor', { message: text }] };
          const payload = '4' + JSON.stringify(fallback);
          return window.tawkSendRaw(payload);
        }

        // deep clone template and replace the message
        const tpl = JSON.parse(JSON.stringify(lastTemplate));
        // find the p[2] message object (structure observed in interception)
        if (tpl.p && tpl.p[2] && typeof tpl.p[2] === 'object') {
          tpl.p[2].message = text;
        } else {
          tpl.p[2] = { message: text };
        }
        const packet = '4' + JSON.stringify(tpl);
        window.tawkSendRaw(packet);
      };

      console.log('Interceptor ready');
    })();

    var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
    (function () {
      var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = 'https://embed.tawk.to/68f9a0afd84f3b1958007fd2/1j87hnbo1';
      s1.charset = 'UTF-8';
      s1.setAttribute('crossorigin', '*');
      s0.parentNode.insertBefore(s1, s0);
    })();
    window.Tawk_API.onLoad = function () {
      window.Tawk_API.setAttributes(
        {
          name: 'John Doe' + Date.now(),
          email: 'visitor@yourdomain.com',
          id: 'USER-123',         // optional custom ID for your tracking
          // hash: 'SECURE_HASH'     // optional, for secure mode
        },
        function (error) {
          if (error) console.error('Tawk setAttributes error:', error);
          else console.log('Attributes set');
        }
      );
    };

  </script>
  <!--End of Tawk.to Script-->
</body>

</html>